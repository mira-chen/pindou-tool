<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>拼豆图纸生成器 - V28.11 公网发布版</title>

    <script src="beads_db.js"></script>
    <link href="https://cdn.bootcdn.net/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">

    <style>
        /* ================== 全局变量 ================== */
        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --bg-sidebar: #ffffff;
            --bg-main: #f8fafc;
            --border: #e2e8f0;
            --text-main: #1e293b;
            --text-sub: #64748b;
            --radius: 12px;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            outline: none;
        }

        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-main);
            color: var(--text-main);
        }

        .app-layout {
            display: flex;
            height: 100%;
            width: 100%;
            position: relative;
        }

        /* ================== 侧边栏 ================== */
        .sidebar {
            width: 280px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            z-index: 50;
            box-shadow: 4px 0 20px rgba(0,0,0,0.02);
            flex-shrink: 0;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar-header {
            padding: 20px;
            background: #fff;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

            .sidebar-header h2 {
                margin: 0;
                font-size: 18px;
                font-weight: 800;
                background: linear-gradient(135deg, #4f46e5 0%, #ec4899 100%);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
            }

        .btn-close-sidebar {
            display: none;
            font-size: 13px;
            color: var(--text-sub);
            background: #f1f5f9;
            border: none;
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            -webkit-overflow-scrolling: touch;
        }

        /* ================== 控件 ================== */
        .control-group {
            margin-bottom: 20px;
        }

        .label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            font-weight: 700;
            color: #334155;
            margin-bottom: 8px;
        }

        select, input[type="text"] {
            width: 100%;
            font-size: 13px;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background-color: #fff;
        }

        select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 16px;
        }

        /* Tab 切换样式 */
        .tab-group {
            display: flex;
            background: #f1f5f9;
            padding: 4px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .tab-btn {
            flex: 1;
            border: none;
            background: transparent;
            padding: 8px;
            font-size: 13px;
            font-weight: 600;
            color: #64748b;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

            .tab-btn.active {
                background: #fff;
                color: var(--primary);
                box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            }

        .input-panel {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .file-upload-wrapper {
            position: relative;
            width: 100%;
        }

        .file-upload-input {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            z-index: 2;
        }

        .file-upload-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 12px;
            background: #fff;
            border: 1px dashed #cbd5e1;
            border-radius: 8px;
            color: #64748b;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .file-upload-wrapper:hover .file-upload-btn {
            border-color: var(--primary);
            color: var(--primary);
            background: #f5f3ff;
        }

        #preview-box {
            margin-top: 10px;
            height: 140px;
            background: #f1f5f9;
            border: 2px solid #fff;
            border-radius: var(--radius);
            box-shadow: inset 0 2px 6px rgba(0,0,0,0.05);
            display: none;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        #preview-img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .btn-recrop {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(4px);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .range-wrap {
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-sub);
            background: #f8fafc;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        input[type="range"] {
            flex: 1;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .number-input {
            width: 50px !important;
            text-align: center;
            color: var(--primary);
            font-weight: 800;
            font-size: 14px;
            border: none !important;
            background: transparent;
            padding: 0 !important;
        }

        /* 🆕 预设尺寸按钮 */
        .btn-preset-trigger {
            width: 100%;
            background: #eff6ff;
            color: var(--primary);
            border: 1px solid #bfdbfe;
            padding: 10px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

            .btn-preset-trigger:hover {
                background: #dbeafe;
            }

        .btn-run {
            background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 10px;
            width: 100%;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 5px;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4);
        }

        .btn-export {
            background: #10b981;
            color: white;
            border: none;
            padding: 14px;
            border-radius: 10px;
            width: 100%;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
            margin-top: 12px;
            display: none;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }

        .btn-donate {
            background: linear-gradient(135deg, #ff758c 0%, #ff7eb3 100%);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 10px;
            width: 100%;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(255, 117, 140, 0.3);
        }

            .btn-donate:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 15px rgba(255, 117, 140, 0.4);
            }

        /* ================== 主画布 ================== */
        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            padding: 0;
            position: relative;
            background-color: #f1f5f9;
            background-image: radial-gradient(#cbd5e1 1.5px, transparent 1.5px);
            background-size: 20px 20px;
        }

        .canvas-stage {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: auto;
            position: relative;
            padding: 40px;
            width: 100%;
        }

        #zoom-container {
            display: block;
            transition: width 0.1s, height 0.1s;
            margin: auto;
        }

        #pixel-grid {
            background: #fff;
            border: 3px solid #1e293b;
            display: grid;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            transform-origin: 0 0;
            transition: transform 0.1s linear;
        }

        .pixel {
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            font-weight: normal;
            font-family: Arial, sans-serif;
            letter-spacing: -0.5px;
            white-space: nowrap;
            transition: color 0.3s ease;
        }

        .cursor-pen .pixel {
            cursor: crosshair;
        }

        .cursor-picker .pixel {
            cursor: alias;
        }

        .active-color-indicator {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 0 0 1px #cbd5e1;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }

        .thick-r {
            border-right: 1px solid rgba(30, 41, 59, 0.25) !important;
            z-index: 5;
        }

        .thick-b {
            border-bottom: 1px solid rgba(30, 41, 59, 0.25) !important;
            z-index: 5;
        }

        #pixel-grid.pure-mode {
            border-color: transparent !important;
            box-shadow: none;
            gap: 0;
        }

            #pixel-grid.pure-mode .pixel {
                color: transparent !important;
            }

            #pixel-grid.pure-mode .thick-r, #pixel-grid.pure-mode .thick-b {
                border-color: transparent !important;
            }

        /* 工具栏 */
        .canvas-toolbar {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 45;
            display: none;
            flex-direction: column;
            gap: 10px;
            align-items: flex-end;
        }

        .btn-tool {
            background: white;
            border: 1px solid var(--border);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            color: #475569;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

            .btn-tool:hover {
                background: #f8fafc;
                transform: translateY(-1px);
            }

            .btn-tool.active {
                background: var(--primary);
                color: white;
                border-color: var(--primary);
            }

        .zoom-controls {
            background: white;
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 4px;
            display: flex;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        .zoom-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            font-size: 16px;
            color: #475569;
            cursor: pointer;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

            .zoom-btn:hover {
                background: #f1f5f9;
                color: var(--primary);
            }

        .zoom-text {
            font-size: 12px;
            font-weight: 700;
            color: var(--text-main);
            width: 45px;
            text-align: center;
            cursor: pointer;
        }

        .stats-panel {
            max-height: 25vh;
            min-height: 120px;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(12px);
            border-top: 1px solid var(--border);
            display: none;
            flex-direction: column;
            z-index: 40;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
            border-radius: 16px 16px 0 0;
            margin: 0 10px;
        }

        .stats-header {
            padding: 12px 20px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            font-weight: bold;
            color: var(--text-main);
        }

        .stats-body {
            padding: 15px 20px;
            overflow-y: auto;
            flex: 1;
            -webkit-overflow-scrolling: touch;
        }

        .mini-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-content: flex-start;
        }

        .mini-tag {
            display: flex;
            align-items: center;
            gap: 6px;
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 12px;
            color: var(--text-main);
            height: 28px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
        }

        .mini-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 1px solid rgba(0,0,0,0.1);
        }

        .empty-tip {
            text-align: center;
            color: #94a3b8;
            margin-top: 0;
            border: 3px dashed #cbd5e1;
            border-radius: 20px;
            padding: 60px;
            background: rgba(255,255,255,0.6);
            backdrop-filter: blur(4px);
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: 0.3s;
        }

            .empty-tip:hover {
                border-color: var(--primary);
                color: var(--primary);
                transform: scale(1.02);
            }

            .empty-tip svg {
                width: 64px;
                height: 64px;
                margin-bottom: 15px;
                opacity: 0.5;
            }

        .fab-settings {
            position: absolute;
            bottom: 30px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 20px rgba(79, 70, 229, 0.4);
            z-index: 45;
            cursor: pointer;
            border: none;
            font-size: 24px;
            transition: transform 0.2s;
        }

            .fab-settings:active {
                transform: scale(0.9);
            }

        /* 弹窗通用样式 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            z-index: 100;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: #fff;
            padding: 20px;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            max-height: 90vh;
            overflow-y: auto;
        }

        /* 🆕 尺寸选择面板专属样式 */
        .size-modal-body {
            padding: 0 5px;
        }

        .size-cat-title {
            font-size: 14px;
            font-weight: 700;
            color: #334155;
            margin: 15px 0 8px 0;
            display: flex;
            align-items: center;
            gap: 6px;
        }

            .size-cat-title span {
                font-size: 11px;
                font-weight: 400;
                color: #94a3b8;
            }

        .size-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .size-card {
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
            background: #fff;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

            .size-card:hover {
                border-color: var(--primary);
                box-shadow: 0 4px 12px rgba(79, 70, 229, 0.1);
                transform: translateY(-2px);
            }

            .size-card.active {
                border-color: var(--primary);
                background: #eff6ff;
            }

        .size-card-dim {
            font-size: 16px;
            font-weight: 800;
            color: var(--text-main);
        }

        .size-card-info {
            font-size: 12px;
            color: #64748b;
            display: flex;
            justify-content: space-between;
        }

        .size-card-desc {
            font-size: 11px;
            color: #94a3b8;
            margin-top: 2px;
        }

        .img-crop-container {
            width: 100%;
            background: #eee;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            justify-content: center;
            flex-shrink: 1;
            min-height: 200px;
            max-height: 50vh;
        }

        #image-to-crop {
            max-width: 100%;
            display: block;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            flex-shrink: 0;
            margin-top: auto;
        }

        .btn-cancel {
            background: #f1f5f9;
            color: var(--text-sub);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-confirm {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(5px);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                transform: translateX(0);
                border-right: none;
            }

                .sidebar.hidden {
                    transform: translateX(-100%);
                }

            .fab-settings {
                display: flex;
            }

            .btn-close-sidebar {
                display: block;
            }

            .canvas-stage {
                padding: 10px;
            }

            .stats-panel {
                max-height: 40vh;
            }

            .empty-tip {
                padding: 40px 20px;
                margin-top: 60px;
            }
        }
    </style>
</head>
<body>

    <div class="app-layout">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>🧩 拼豆助手</h2>
                <button class="btn-close-sidebar" onclick="toggleSidebar(false)">收起</button>
            </div>
            <div class="sidebar-content">
                <div class="control-group">
                    <span class="label">🎨 品牌与套装</span>
                    <div style="display:flex; gap:8px;">
                        <select id="brand-select" onchange="updateData()" style="flex:1"><option>...</option></select>
                        <select id="range-select" onchange="updateData()" style="width:120px;">
                            <option value="SET_295" selected>全色系 (295)</option>
                            <option value="SET_221">基础系 (221)</option>
                            <option value="SET_144">144色套装</option>
                            <option value="SET_120">120色套装</option>
                            <option value="SET_96">96色套装</option>
                            <option value="SET_72">72色套装</option>
                            <option value="SET_48">48色套装</option>
                            <option value="SET_24">24色套装</option>
                        </select>
                    </div>

                    <div style="margin-top:10px;">
                        <span class="label" style="font-weight:normal; font-size:12px; color:#64748b;">📏 豆豆规格 (影响成品尺寸估算)</span>
                        <select id="bead-size-select" onchange="generate()">
                            <option value="2.65" selected>2.6mm 迷你豆 (推荐)</option>
                            <option value="5.0">5.0mm 标准豆</option>
                        </select>
                    </div>
                    <div id="brand-info" style="font-size:11px; color:#94a3b8; margin-top:6px; margin-left: 2px;"></div>
                </div>

                <div class="control-group">
                    <span class="label">🖼️ 素材来源</span>

                    <div class="tab-group">
                        <button id="tab-img" class="tab-btn active" onclick="switchTab('img')">上传图片</button>
                        <button id="tab-text" class="tab-btn" onclick="switchTab('text')">定制文字</button>
                    </div>

                    <div id="panel-img" class="input-panel">
                        <div class="file-upload-wrapper">
                            <button class="file-upload-btn">
                                <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                                上传图片文件
                            </button>
                            <input type="file" id="upload" accept="image/*" class="file-upload-input" onchange="handleFileSelect(this)">
                        </div>
                    </div>

                    <div id="panel-text" class="input-panel" style="display:none;">
                        <input type="text" id="text-input" placeholder="输入文字 (如: Hi)" style="margin-bottom:8px;">

                        <div style="display:flex; gap:8px; margin-bottom:10px;">
                            <select id="font-select" style="flex:1;">
                                <option value="Arial">默认黑体 (Sans)</option>
                                <option value="Times New Roman">经典宋体 (Serif)</option>
                                <option value="Cursive">手写风格 (Cursive)</option>
                                <option value="Courier New">像素/打字机 (Mono)</option>
                            </select>
                            <input type="color" id="text-color" value="#000000" title="文字颜色" style="height:38px; width:40px; border:none; background:none; cursor:pointer;">
                        </div>

                        <button class="btn-tool" style="width:100%; justify-content:center; background:#f1f5f9; color:var(--primary); border-color:var(--primary);" onclick="generateTextImg()">
                            ⚡ 生成文字预览
                        </button>
                    </div>

                    <div id="preview-box">
                        <img id="preview-img">
                        <button class="btn-recrop" onclick="reCrop()">✂️ 重新裁切</button>
                    </div>
                </div>

                <div class="control-group">
                    <span class="label">⚙️ 尺寸设置</span>

                    <button class="btn-preset-trigger" onclick="openSizeModal()">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 4l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path></svg>
                        选择常用尺寸 (推荐)
                    </button>

                    <label style="display:flex; align-items:center; cursor:pointer; margin-bottom:8px; font-size:13px;">
                        <input type="checkbox" id="mirror-image" style="margin-right:8px;"> 🪞 镜像翻转图片
                    </label>

                    <span class="label" style="font-weight:normal; font-size:12px; color:#64748b;">宽度设置 (20 - 300格)</span>
                    <div class="range-wrap">
                        <input type="range" id="size-range" min="20" max="300" value="50" oninput="syncSize('range')">
                        <input type="number" id="size-input" class="number-input" min="20" max="300" value="50" oninput="syncSize('input')" onblur="fixInput()">
                    </div>
                </div>

                <div class="control-group" style="display:flex; gap:15px; font-size:13px; margin-top:25px;">
                    <label style="display:flex; align-items:center; cursor:pointer;"><input type="radio" name="mode" value="original" checked style="margin-right:6px;"> 原色预览</label>
                    <label style="display:flex; align-items:center; cursor:pointer;"><input type="radio" name="mode" value="match" style="margin-right:6px;"> 拼豆图纸</label>
                </div>

                <button class="btn-run" onclick="generate()">✨ 开始生成</button>

                <button id="btn-export" class="btn-export" onclick="downloadImage()">💾 导出高清图纸</button>

                <button class="btn-donate" onclick="openDonateModal()">
                    ☕ 请作者喝杯咖啡
                </button>

                <div style="height:50px;"></div>
            </div>
        </aside>

        <div class="main-area">
            <div class="canvas-stage">
                <div id="canvas-toolbar" class="canvas-toolbar">
                    <div style="display:flex; gap:8px; margin-bottom:5px;">
                        <div id="current-color-show" class="active-color-indicator" style="background:transparent;"></div>

                        <button id="btn-picker" class="btn-tool" onclick="setTool('picker')" title="吸管：点击画面吸取颜色">
                            🖊️ 吸管
                        </button>
                        <button id="btn-pen" class="btn-tool" onclick="setTool('pen')" title="画笔：点击画面修改颜色">
                            🖌️ 画笔
                        </button>
                    </div>

                    <button id="btn-pure-toggle" class="btn-tool" onclick="togglePureMode()">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                        纯净预览
                    </button>

                    <div class="zoom-controls">
                        <button class="zoom-btn" onclick="changeZoom(-0.1)">-</button>
                        <span class="zoom-text" id="zoom-level" onclick="resetZoom()">100%</span>
                        <button class="zoom-btn" onclick="changeZoom(0.1)">+</button>
                    </div>
                </div>

                <div id="zoom-container">
                    <div id="pixel-grid"></div>
                </div>

                <div id="empty-state" class="empty-tip" onclick="document.getElementById('upload').click()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    <p style="font-weight:600; font-size:16px; margin:0; color:#475569;">点击上传图片</p>
                    <p style="font-size:13px; opacity:0.6; margin-top:5px;">支持电脑 / 手机</p>
                </div>
            </div>

            <button class="fab-settings" onclick="toggleSidebar(true)">⚙️</button>

            <div id="stats-panel" class="stats-panel">
                <div class="stats-header">
                    <div>📊 材料统计 <span id="total-text" style="color:var(--primary); margin-left:8px; font-weight:800;"></span><span id="physical-size" class="size-info"></span></div>
                </div>
                <div id="mini-list" class="mini-list stats-body"></div>
            </div>
        </div>
    </div>

    <div id="crop-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h3>✂️ 裁切素材</h3></div>
            <div class="img-crop-container"><img id="image-to-crop" src=""></div>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeCropModal()">取消</button>
                <button class="btn-confirm" onclick="confirmCrop()">确定</button>
            </div>
        </div>
    </div>

    <div id="size-modal" class="modal-overlay" onclick="closeSizeModal(event)">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header"><h3>📏 选择画布尺寸</h3></div>
            <div class="size-modal-body">

                <div class="size-cat-title">🔥 推荐级 <span>质量与成本的平衡</span></div>
                <div class="size-grid">
                    <div class="size-card" onclick="selectPresetSize(50, 1)">
                        <div class="size-card-dim">50×50</div>
                        <div class="size-card-info"><span>2500豆</span><span>耗时4小时</span></div>
                        <div class="size-card-desc">最受欢迎尺寸 (大板)</div>
                    </div>
                    <div class="size-card" onclick="selectPresetSize(52, 1)">
                        <div class="size-card-dim">52×52</div>
                        <div class="size-card-info"><span>2704豆</span><span>耗时4小时+</span></div>
                        <div class="size-card-desc">经典拼豆板标准尺寸</div>
                    </div>
                </div>

                <div class="size-cat-title">🐣 入门级 <span>小型项目，适合新手</span></div>
                <div class="size-grid">
                    <div class="size-card" onclick="selectPresetSize(16, 1)">
                        <div class="size-card-dim">16×16</div>
                        <div class="size-card-info"><span>256豆</span><span>耗时30分钟</span></div>
                        <div class="size-card-desc">钥匙扣、小装饰</div>
                    </div>
                    <div class="size-card" onclick="selectPresetSize(26, 1)">
                        <div class="size-card-dim">26×26</div>
                        <div class="size-card-info"><span>676豆</span><span>耗时1小时</span></div>
                        <div class="size-card-desc">卡通头像、胸针</div>
                    </div>
                    <div class="size-card" onclick="selectPresetSize(32, 1)">
                        <div class="size-card-dim">32×32</div>
                        <div class="size-card-info"><span>1024豆</span><span>耗时2小时</span></div>
                        <div class="size-card-desc">标准装饰画</div>
                    </div>
                </div>

                <div class="size-cat-title">🚀 进阶级 <span>大型艺术作品</span></div>
                <div class="size-grid">
                    <div class="size-card" onclick="selectPresetSize(64, 1)">
                        <div class="size-card-dim">64×64</div>
                        <div class="size-card-info"><span>4096豆</span><span>耗时6小时+</span></div>
                        <div class="size-card-desc">高质量细节作品</div>
                    </div>
                </div>

            </div>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeSizeModal()">关闭</button>
            </div>
        </div>
    </div>

    <div id="donate-modal" class="modal-overlay" onclick="closeDonateModal(event)">
        <div class="modal-content" style="max-width: 320px; text-align: center;">
            <div class="modal-header" style="justify-content: center;">
                <h3>💖 感谢支持</h3>
            </div>
            <div style="padding: 10px;">
                <p style="color:#64748b; font-size:14px; margin-bottom:15px;">
                    如果这个工具对你有帮助，<br>欢迎打赏支持~ 🌹
                </p>
                <div style="background: #f8fafc; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0; display: inline-block;">
                    <img src="donate.png" alt="收款码" style="width: 200px; height: 200px; display: block; border-radius: 4px;"
                         onerror="this.style.display='none'; this.parentNode.innerHTML='<span style=\'color:red\'>⚠️ 请上传名为 donate.png 的图片</span>'">
                </div>
            </div>
            <div class="modal-actions" style="justify-content: center; margin-top:15px;">
                <button class="btn-cancel" onclick="closeDonateModal()">关闭</button>
            </div>
        </div>
    </div>

    <div id="loading-overlay"><div class="spinner"></div><p style="margin-top:15px; color:#475569; font-weight:600; font-size:14px;">正在处理...</p></div>
    <canvas id="tempCanvas" style="display:none;"></canvas>

    <script src="https://cdn.bootcdn.net/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <script>
        let uploadedImg = null; let currentList = []; let currentMap = {}; let currentImgData = null; let currentWidth = 0; let currentHeight = 0; let isMatchMode = false;
        let cropper = null; const cropModal = document.getElementById('crop-modal'); const imageToCrop = document.getElementById('image-to-crop'); let originalFileSrc = null;

        let isPureMode = false;
        let currentZoom = 1.0;
        const BASE_CELL_SIZE = 20;

        // 🟢 初始化
        window.onload = function () {
            if (typeof ALL_BRANDS === 'undefined') { alert("❌ 缺少 beads_db.js"); return; }
            const sel = document.getElementById('brand-select'); sel.innerHTML = ''; Object.keys(ALL_BRANDS).forEach(b => sel.add(new Option(b, b))); if (sel.length > 0) { sel.selectedIndex = 0; updateData(); }
        }

        // ================== 🆕 Tab & 文字模式功能 ==================
        function switchTab(type) {
            document.getElementById('tab-img').className = type === 'img' ? 'tab-btn active' : 'tab-btn';
            document.getElementById('tab-text').className = type === 'text' ? 'tab-btn active' : 'tab-btn';
            document.getElementById('panel-img').style.display = type === 'img' ? 'block' : 'none';
            document.getElementById('panel-text').style.display = type === 'text' ? 'block' : 'none';
        }

        function handleFileSelect(input) {
            const file = input.files[0];
            if (!file) return;
            // 更新UI文字
            input.previousElementSibling.innerHTML = `<svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> 重新选择`;
            const reader = new FileReader();
            reader.onload = function (evt) {
                originalFileSrc = evt.target.result;
                openCropModal(originalFileSrc);
            };
            reader.readAsDataURL(file);
            input.value = ''; // 清空，允许重复选择同一文件
        }

        function generateTextImg() {
            const text = document.getElementById('text-input').value.trim();
            if (!text) { alert("请输入需要定制的文字~"); return; }

            const font = document.getElementById('font-select').value;
            const color = document.getElementById('text-color').value;

            // 1. 创建临时 Canvas
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const fontSize = 200;
            ctx.font = `bold ${fontSize}px ${font}`;

            // 2. 计算文字尺寸
            const metrics = ctx.measureText(text);
            const textWidth = metrics.width;
            const textHeight = fontSize * 1.4; // 适当留高

            canvas.width = textWidth + 60;
            canvas.height = textHeight + 60;

            // 3. 绘制白底 (Cropper 更好处理白底)
            ctx.fillStyle = "#ffffff";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // 4. 绘制文字
            ctx.font = `bold ${fontSize}px ${font}`;
            ctx.fillStyle = color;
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(text, canvas.width / 2, canvas.height / 2);

            // 5. 转为图片并打开裁切
            originalFileSrc = canvas.toDataURL('image/png');
            openCropModal(originalFileSrc);
        }

        // ================== 🆕 预设尺寸功能 (带正方形锁定) ==================
        function openSizeModal() {
            document.getElementById('size-modal').style.display = 'flex';
        }

        function closeSizeModal(e) {
            if (!e || e.target.id === 'size-modal' || e.target.classList.contains('btn-cancel')) {
                document.getElementById('size-modal').style.display = 'none';
            }
        }

        function selectPresetSize(size, ratio = null) {
            const input = document.getElementById('size-input');
            const range = document.getElementById('size-range');

            input.value = size;
            range.value = size;

            closeSizeModal();

            // 🔥 核心逻辑：如果是正方形预设，强制打开裁切框并锁定比例
            // 🔥 增加了 originalFileSrc 判断，确保文字模式下也能正常触发！
            if (ratio && originalFileSrc) {
                setTimeout(() => {
                    if (confirm(`为了生成完美的 ${size}x${size} 正方形，\n我们需要对图片进行 1:1 裁切。\n\n是否现在进行裁切？`)) {
                        openCropModal(originalFileSrc, ratio);
                    }
                }, 100);
            } else {
                input.style.transition = 'background 0.2s';
                input.style.background = '#dbeafe';
                setTimeout(() => { input.style.background = 'transparent'; }, 300);
            }
        }

        // ================== 原有逻辑 ==================

        function updateData() {
            const brandName = document.getElementById('brand-select').value;
            const setName = document.getElementById('range-select').value;
            if (typeof getSetColors === 'function') {
                currentList = getSetColors(brandName, setName);
            } else {
                console.error("无法找到 getSetColors 函数"); currentList = [];
            }
            document.getElementById('brand-info').innerText = `${brandName} | ${setName.replace('SET_', '')}色系 | 可用: ${currentList.length}色`;
        }

        function toggleSidebar(show) { const sidebar = document.getElementById('sidebar'); if (show) { sidebar.classList.remove('hidden'); } else { sidebar.classList.add('hidden'); } }

        function togglePureMode() {
            isPureMode = !isPureMode;
            const grid = document.getElementById('pixel-grid');
            const btn = document.getElementById('btn-pure-toggle');

            if (isPureMode) {
                grid.classList.add('pure-mode');
                btn.classList.add('active');
                btn.innerHTML = `<svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg> 显示色号`;
            } else {
                grid.classList.remove('pure-mode');
                btn.classList.remove('active');
                btn.innerHTML = `<svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg> 纯净预览`;
            }
        }

        function changeZoom(delta) {
            currentZoom += delta;
            currentZoom = Math.max(0.1, Math.min(3.0, currentZoom));
            applyZoom();
        }

        function resetZoom() {
            if (!currentWidth || !currentHeight) return;
            const stage = document.querySelector('.canvas-stage');
            const gridRealW = currentWidth * BASE_CELL_SIZE;
            const stageW = stage.clientWidth - 80;
            currentZoom = Math.max(0.3, Math.min(1.0, stageW / gridRealW));
            applyZoom();
        }

        function applyZoom() {
            const grid = document.getElementById('pixel-grid');
            const container = document.getElementById('zoom-container');
            grid.style.transform = `scale(${currentZoom})`;
            const realW = currentWidth * BASE_CELL_SIZE * currentZoom;
            const realH = currentHeight * BASE_CELL_SIZE * currentZoom;
            container.style.width = `${realW}px`;
            container.style.height = `${realH}px`;
            document.getElementById('zoom-level').innerText = Math.round(currentZoom * 100) + '%';
        }

        function syncSize(source) {
            const range = document.getElementById('size-range'); const input = document.getElementById('size-input');
            if (source === 'range') { input.value = range.value; }
            else {
                let val = parseInt(input.value); if (isNaN(val)) return;
                if (val >= 20 && val <= 300) { range.value = val; }
                if (val > 300) { val = 300; input.value = 300; range.value = 300; }
            }
        }
        function fixInput() {
            const range = document.getElementById('size-range'); const input = document.getElementById('size-input'); let val = parseInt(input.value);
            if (isNaN(val) || val < 20) { val = 20; } if (val > 300) { val = 300; } input.value = val; range.value = val;
        }

        // 修改了裁切函数，支持 ratio 参数
        function openCropModal(src, ratio = NaN) {
            imageToCrop.src = src;
            cropModal.style.display = 'flex';

            if (cropper) { cropper.destroy(); cropper = null; }

            cropper = new Cropper(imageToCrop, {
                viewMode: 1,
                dragMode: 'move',
                autoCropArea: 0.8,
                restore: false,
                guides: true,
                center: true,
                highlight: false,
                cropBoxMovable: true,
                cropBoxResizable: true,
                toggleDragModeOnDblclick: false,
                aspectRatio: ratio
            });
        }
        function closeCropModal() { cropModal.style.display = 'none'; if (cropper) cropper.destroy(); cropper = null; }

        function confirmCrop() {
            if (!cropper) return; showLoading(true);
            const canvas = cropper.getCroppedCanvas({ width: 800 });
            const newImg = new Image();
            newImg.onload = () => {
                uploadedImg = newImg;
                document.getElementById('preview-box').style.display = 'flex';
                document.getElementById('preview-img').src = newImg.src;
                document.getElementById('empty-state').style.display = 'none';
                document.getElementById('btn-export').style.display = 'none';
                closeCropModal(); showLoading(false);
            };
            newImg.src = canvas.toDataURL('image/jpeg', 0.85);
        }

        function reCrop() { if (originalFileSrc) openCropModal(originalFileSrc); }
        function findColor(r, g, b) { let min = Infinity, res = { name: "?", r: 255, g: 255, b: 255 }; if (!currentList.length) return res; for (let c of currentList) { let d = Math.sqrt((r - c.r) ** 2 + (g - c.g) ** 2 + (b - c.b) ** 2); if (d < min) { min = d; res = c; } } return res; }

        function generate() {
            if (!uploadedImg) { alert("请先上传图片或生成文字~"); return; }
            showLoading(true);
            if (window.innerWidth <= 768) { toggleSidebar(false); }
            setTimeout(() => { try { performGenerate(); } catch (e) { console.error(e); alert("生成出错"); } finally { showLoading(false); } }, 10);
        }

        function performGenerate() {
            document.getElementById('stats-panel').style.display = 'none';
            document.getElementById('canvas-toolbar').style.display = 'none';

            currentWidth = parseInt(document.getElementById('size-range').value);
            const mode = document.querySelector('input[name="mode"]:checked').value; isMatchMode = (mode === 'match');
            currentHeight = Math.round(currentWidth * (uploadedImg.height / uploadedImg.width));
            const cvs = document.getElementById('tempCanvas'); const ctx = cvs.getContext('2d'); cvs.width = currentWidth; cvs.height = currentHeight;

            // 镜像翻转
            const useMirror = document.getElementById('mirror-image').checked;
            ctx.clearRect(0, 0, currentWidth, currentHeight);
            ctx.save();
            if (useMirror) {
                ctx.translate(currentWidth, 0);
                ctx.scale(-1, 1);
            }
            ctx.drawImage(uploadedImg, 0, 0, currentWidth, currentHeight);
            ctx.restore();

            currentImgData = ctx.getImageData(0, 0, currentWidth, currentHeight).data;

            const grid = document.getElementById('pixel-grid'); grid.innerHTML = '';
            grid.style.gridTemplateColumns = `repeat(${currentWidth}, ${BASE_CELL_SIZE}px)`;
            grid.style.width = `${currentWidth * BASE_CELL_SIZE}px`;

            isPureMode = false;
            document.getElementById('btn-pure-toggle').classList.remove('active');
            document.getElementById('btn-pure-toggle').innerHTML = `<svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg> 纯净预览`;
            grid.classList.remove('pure-mode');

            const fragment = document.createDocumentFragment(); let total = 0; currentMap = {};

            for (let i = 0; i < currentImgData.length; i += 4) {
                let r = currentImgData[i], g = currentImgData[i + 1], b = currentImgData[i + 2], a = currentImgData[i + 3]; let idx = i / 4, col = idx % currentWidth, row = Math.floor(idx / currentWidth);
                let div = document.createElement('div'); div.className = 'pixel'; div.style.height = `${BASE_CELL_SIZE}px`;
                div.dataset.idx = i;
                if ((col + 1) % 10 === 0 && col + 1 < currentWidth) div.classList.add('thick-r');
                if ((row + 1) % 10 === 0 && row + 1 < currentHeight) div.classList.add('thick-b');

                if (a < 128) {
                    div.style.background = 'transparent'; div.style.border = 'none';
                } else {
                    total++;
                    if (!isMatchMode) {
                        div.style.background = `rgb(${r},${g},${b})`;
                    } else {
                        let match = findColor(r, g, b);
                        div.style.background = `rgb(${match.r},${match.g},${match.b})`;
                        div.innerText = match.name;
                        const yiq = (match.r * 299 + match.g * 587 + match.b * 114) / 1000;
                        div.style.color = yiq >= 128 ? '#000000' : '#ffffff';
                        div.style.fontSize = '9px';
                        if (!currentMap[match.name]) currentMap[match.name] = { count: 0, c: match }; currentMap[match.name].count++;
                    }
                }
                fragment.appendChild(div);
            }
            grid.appendChild(fragment);

            resetZoom();
            document.getElementById('canvas-toolbar').style.display = 'flex';

            if (isMatchMode && total > 0) {
                document.getElementById('stats-panel').style.display = 'flex';
                document.getElementById('btn-export').style.display = 'block';
                document.getElementById('total-text').innerText = `${total} 颗`;
                const beadSizeMm = parseFloat(document.getElementById('bead-size-select').value);
                const wCm = (currentWidth * beadSizeMm / 10).toFixed(1);
                const hCm = (currentHeight * beadSizeMm / 10).toFixed(1);
                document.getElementById('physical-size').innerText = `| 约 ${wCm}x${hCm}cm`;
                const list = document.getElementById('mini-list'); list.innerHTML = '';
                Object.keys(currentMap).sort().forEach(k => { let item = currentMap[k]; let tag = document.createElement('div'); tag.className = 'mini-tag'; tag.innerHTML = `<div class="mini-dot" style="background:rgb(${item.c.r},${item.c.g},${item.c.b})"></div><b>${k}</b><span style="color:#94a3b8">|</span><span>${item.count}</span>`; list.appendChild(tag); });
            } else { document.getElementById('btn-export').style.display = 'none'; }
        }

        function downloadImage() {
            if (!currentImgData) return;
            showLoading(true);

            setTimeout(() => {
                // 🔒 强制开启水印模式 (去掉了商家开关逻辑)
                const WATERMARK_HEIGHT = 50; // 预留中间水印高度

                const EXPORT_CELL = 30;
                const RULER_SIZE = 30;
                const MARGIN = 40;
                const LEGEND_GAP = 30;

                const cols = currentWidth;
                const rows = currentHeight;
                const gridW = cols * EXPORT_CELL;
                const gridH = rows * EXPORT_CELL;

                const sortedKeys = Object.keys(currentMap).sort((a, b) => currentMap[b].count - currentMap[a].count);

                let minCanvasW = gridW + RULER_SIZE;
                if (minCanvasW < 700) minCanvasW = 700;

                const canvasW = MARGIN + minCanvasW + MARGIN;
                const ITEM_WIDTH = 120;
                const ITEM_HEIGHT = 30;

                const legendAvailableW = minCanvasW;
                const colCount = Math.floor(legendAvailableW / ITEM_WIDTH);
                const rowCount = Math.ceil(sortedKeys.length / Math.max(1, colCount));
                const legendH = 40 + (rowCount * ITEM_HEIGHT);

                // 🔥 高度包含中间层
                const canvasH = MARGIN + RULER_SIZE + gridH + WATERMARK_HEIGHT + LEGEND_GAP + legendH + MARGIN;

                const cvs = document.createElement('canvas');
                cvs.width = canvasW;
                cvs.height = canvasH;
                const ctx = cvs.getContext('2d');

                ctx.fillStyle = "#ffffff";
                ctx.fillRect(0, 0, canvasW, canvasH);

                const startX = MARGIN + RULER_SIZE;
                const startY = MARGIN + RULER_SIZE;

                // 1. 标尺
                ctx.fillStyle = "#666666";
                ctx.font = "12px Arial";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                for (let c = 0; c < cols; c++) {
                    let px = startX + c * EXPORT_CELL + EXPORT_CELL / 2;
                    let num = c + 1;
                    if (num % 5 === 0 || num === 1) ctx.fillText(num, px, MARGIN + RULER_SIZE / 2);
                }
                for (let r = 0; r < rows; r++) {
                    let py = startY + r * EXPORT_CELL + EXPORT_CELL / 2;
                    let num = r + 1;
                    if (num % 5 === 0 || num === 1) ctx.fillText(num, MARGIN + RULER_SIZE / 2, py);
                }

                // 2. 格子
                ctx.font = "bold 13px Helvetica, Arial, sans-serif";
                for (let i = 0; i < currentImgData.length; i += 4) {
                    let r = currentImgData[i], g = currentImgData[i + 1], b = currentImgData[i + 2], a = currentImgData[i + 3];
                    let idx = i / 4, col = idx % cols, row = Math.floor(idx / cols);
                    let x = startX + col * EXPORT_CELL;
                    let y = startY + row * EXPORT_CELL;

                    if (a < 128) {
                        ctx.fillStyle = "#f9fafb";
                        ctx.fillRect(x, y, EXPORT_CELL, EXPORT_CELL);
                    } else {
                        let match = findColor(r, g, b);
                        ctx.fillStyle = `rgb(${match.r},${match.g},${match.b})`;
                        ctx.fillRect(x, y, EXPORT_CELL, EXPORT_CELL);
                        let yiq = (match.r * 299 + match.g * 587 + match.b * 114) / 1000;
                        ctx.fillStyle = yiq >= 128 ? "#000000" : "#ffffff";
                        ctx.fillText(match.name, x + EXPORT_CELL / 2, y + EXPORT_CELL / 2);
                    }
                    ctx.strokeStyle = "rgba(0,0,0,0.1)";
                    ctx.lineWidth = 1;
                    ctx.strokeRect(x, y, EXPORT_CELL, EXPORT_CELL);
                }

                // 3. 大网格线
                ctx.strokeStyle = "#000000";
                ctx.lineWidth = 2;
                for (let c = 0; c <= cols; c += 10) {
                    ctx.beginPath(); ctx.moveTo(startX + c * EXPORT_CELL, startY); ctx.lineTo(startX + c * EXPORT_CELL, startY + gridH); ctx.stroke();
                }
                for (let r = 0; r <= rows; r += 10) {
                    ctx.beginPath(); ctx.moveTo(startX, startY + r * EXPORT_CELL); ctx.lineTo(startX + gridW, startY + r * EXPORT_CELL); ctx.stroke();
                }
                if (cols % 10 !== 0) ctx.strokeRect(startX, startY, gridW, gridH);

                // 🔥 4. 绘制中间水印 (三明治结构)
                const wmCenterY = startY + gridH + (WATERMARK_HEIGHT / 2) + 5;
                const centerX = canvasW / 2;

                // 分割线
                ctx.beginPath();
                ctx.moveTo(MARGIN, wmCenterY - 20);
                ctx.lineTo(canvasW - MARGIN, wmCenterY - 20);
                ctx.strokeStyle = "#e5e7eb";
                ctx.lineWidth = 1;
                ctx.stroke();

                // 水印文字
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";

                // 品牌名
                ctx.fillStyle = "#374151";
                ctx.font = "bold 16px Helvetica, Arial, sans-serif";
                ctx.fillText("拼豆助手 @半颗猕猴桃", centerX, wmCenterY - 5);

                // 引流信息
                ctx.fillStyle = "#ef4444"; // 红色
                ctx.font = "14px Arial, sans-serif";
                ctx.fillText("🔍 小红书搜：半颗猕猴桃 (号: 8489285563)  |  pindou-tool.netlify.app", centerX, wmCenterY + 15);

                // 5. 绘制材料表
                let legendY = startY + gridH + WATERMARK_HEIGHT + LEGEND_GAP;
                const legendStartX = MARGIN;

                ctx.fillStyle = "#111827";
                ctx.font = "bold 20px Helvetica, Arial, sans-serif";
                ctx.textAlign = "left";
                ctx.textBaseline = "top";
                ctx.fillText("材料清单 / Material List", legendStartX, legendY);
                legendY += 40;

                sortedKeys.forEach((key, index) => {
                    let item = currentMap[key];
                    let colIndex = index % colCount;
                    let rowIndex = Math.floor(index / colCount);
                    let itemX = legendStartX + colIndex * ITEM_WIDTH;
                    let itemY = legendY + rowIndex * ITEM_HEIGHT;

                    ctx.fillStyle = `rgb(${item.c.r},${item.c.g},${item.c.b})`;
                    ctx.fillRect(itemX, itemY, 20, 20);
                    ctx.strokeStyle = "rgba(0,0,0,0.2)";
                    ctx.lineWidth = 1;
                    ctx.strokeRect(itemX, itemY, 20, 20);

                    ctx.fillStyle = "#000";
                    ctx.textAlign = "left";
                    ctx.textBaseline = "middle";
                    ctx.font = "bold 14px monospace";
                    ctx.fillText(key, itemX + 26, itemY + 10);

                    ctx.font = "14px Arial";
                    ctx.fillStyle = "#666";
                    ctx.fillText(`x${item.count}`, itemX + 70, itemY + 10);
                });

                // 6. 底部版权
                const footerY = canvasH - 15;
                ctx.textAlign = "right";
                ctx.fillStyle = "#d1d5db"; // 浅灰色
                ctx.font = "10px Arial";
                ctx.fillText(`Generated by 半颗猕猴桃 @ ${new Date().toLocaleDateString()}`, canvasW - MARGIN, footerY);

                const link = document.createElement('a');
                link.download = `拼豆图纸_${new Date().getTime()}.png`;
                link.href = cvs.toDataURL();
                link.click();
                showLoading(false);

                setTimeout(() => {
                    if (Math.random() < 0.2) {
                        openDonateModal();
                        const modalHeader = document.querySelector('#donate-modal h3');
                        const modalText = document.querySelector('#donate-modal p');
                        if (modalHeader) modalHeader.innerText = "🎉 图纸导出成功！";
                        if (modalText) modalText.innerHTML = "独立开发不易，<br>如果这个工具帮到了你，<br>哪怕 1 块钱也是莫大的鼓励~ 🌹";
                    }
                }, 1500);

            }, 100);
        }

        function showLoading(show) { document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none'; }
        function openDonateModal() { document.getElementById('donate-modal').style.display = 'flex'; }
        function closeDonateModal(e) { if (!e || e.target.id === 'donate-modal' || e.target.classList.contains('btn-cancel')) { document.getElementById('donate-modal').style.display = 'none'; } }

        // 修图相关
        let currentTool = 'none';
        let drawColor = { r: 0, g: 0, b: 0, a: 0 };

        document.getElementById('pixel-grid').addEventListener('click', function (e) {
            if (currentTool === 'none' || !e.target.classList.contains('pixel')) return;
            const idx = parseInt(e.target.dataset.idx);
            if (isNaN(idx)) return;

            if (currentTool === 'picker') {
                const styleColor = e.target.style.backgroundColor;
                if (!styleColor || styleColor === 'transparent' || styleColor.includes('rgba(0, 0, 0, 0)')) {
                    drawColor = { r: 0, g: 0, b: 0, a: 0 };
                } else {
                    const rgb = styleColor.match(/\d+/g);
                    if (rgb && rgb.length >= 3) {
                        drawColor = { r: parseInt(rgb[0]), g: parseInt(rgb[1]), b: parseInt(rgb[2]), a: 255 };
                    } else {
                        drawColor = { r: currentImgData[idx], g: currentImgData[idx + 1], b: currentImgData[idx + 2], a: currentImgData[idx + 3] };
                    }
                }
                updateColorIndicator(drawColor.r, drawColor.g, drawColor.b, drawColor.a);
                setTool('pen');
            } else if (currentTool === 'pen') {
                if (drawColor.a < 128) {
                    e.target.style.background = 'transparent'; e.target.innerText = '';
                } else {
                    e.target.style.background = `rgb(${drawColor.r},${drawColor.g},${drawColor.b})`;
                }
                currentImgData[idx] = drawColor.r;
                currentImgData[idx + 1] = drawColor.g;
                currentImgData[idx + 2] = drawColor.b;
                currentImgData[idx + 3] = drawColor.a;
            }
        });

        function setTool(tool) {
            const grid = document.getElementById('pixel-grid');
            const btnPicker = document.getElementById('btn-picker');
            const btnPen = document.getElementById('btn-pen');
            grid.classList.remove('cursor-pen', 'cursor-picker');
            btnPicker.classList.remove('active');
            btnPen.classList.remove('active');
            if (currentTool === tool) { currentTool = 'none'; return; }
            currentTool = tool;
            if (tool === 'picker') { grid.classList.add('cursor-picker'); btnPicker.classList.add('active'); }
            else if (tool === 'pen') { grid.classList.add('cursor-pen'); btnPen.classList.add('active'); }
        }

        function updateColorIndicator(r, g, b, a) {
            const div = document.getElementById('current-color-show');
            if (a < 128) {
                div.style.background = `linear-gradient(45deg, #ccc 25%, transparent 25%), linear-gradient(-45deg, #ccc 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #ccc 75%), linear-gradient(-45deg, transparent 75%, #ccc 75%)`;
                div.style.backgroundSize = `8px 8px`;
            } else { div.style.background = `rgb(${r},${g},${b})`; }
        }
    </script>
</body>
</html>